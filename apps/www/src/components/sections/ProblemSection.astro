---
/**
 * ProblemSection — Variant 1
 * Signal → Concierge response (keeps stats, improves tone + exchange framing)
 */
import FullViewportSection from '@layouts/FullViewportSection.astro'
import HeroIcons from '@components/icons/HeroIcons.astro'

interface Props {
  className?: string
}

const { className = '' } = Astro.props

const flowSteps = [
  {
    id: 'check-in',
    label: 'Check in',
    description: 'A proactive text that feels like a real associate.',
    icon: 'chat' as const,
  },
  {
    id: 'follow-up',
    label: 'Follow up',
    description: "If they haven't tried it yet, no problem. We'll reach out again later.",
    icon: 'calendar' as const,
  },
  {
    id: 'resolve',
    label: 'Resolve',
    description:
      'Support that saves the sale: fit & styling guidance, plus tailored exchange recommendations.',
    icon: 'camera' as const,
  },
  {
    id: 'route',
    label: 'Return route',
    description: 'If a return is needed, use photos to decide: restock, rework, or keep‑it.',
    icon: 'route' as const,
  },
]

const items = [
  {
    stat: '39%',
    statNote: 'of return requests',
    problem: 'Fit uncertainty',
    problemDesc: 'Wrong size or cut for their preferences.',
    solution: 'Thoughtful personal advice.',
    solutionDesc: 'Confirm the issue then recommend the best size or a better-fitting style.',
  },
  {
    stat: '28%',
    statNote: 'of return requests',
    problem: 'Expectation mismatch',
    problemDesc: 'Color or fabric not as expected.',
    solution: 'Listen and check their photo.',
    solutionDesc: 'Help them find what they will love.',
  },
  {
    stat: '$27',
    statNote: 'avg. handling cost',
    problem: 'Quality concern',
    problemDesc: 'Minor flaw or a real defect.',
    solution: 'Photo-based resolution',
    solutionDesc: 'Decide the right fix: replace, rework, or keep.',
  },
]
---

<FullViewportSection class={className} bg="bg-surface-subtle">
  <div id="problem-section" class="problem-wrapper">
    <!-- Header -->
    <div class="text-center mb-10 sm:mb-14 pt-8 sm:pt-24">
      <h2 class="section-title mb-4">Turn returns into loyalty</h2>
      <p class="text-lg sm:text-xl text-primary leading-relaxed max-w-3xl mx-auto">
        When something isn't right, customers remember how you respond.
      </p>
    </div>

    <!-- Interactive Flow -->
    <div class="mb-10 sm:mb-14 px-4" id="problem-flow">
      <!-- Flow Navigation -->
      <div class="flow-container">
        {
          flowSteps.map((step, index) => (
            <>
              <button
                class={`flow-step ${index === 0 ? 'flow-step-active' : ''}`}
                data-step={step.id}
                aria-label={`View ${step.label} step`}
              >
                <div class="flow-icon">
                  <HeroIcons name={step.icon} />
                </div>
                <span class="flow-label">{step.label}</span>
              </button>
              {index < flowSteps.length - 1 && (
                <div class="flow-connector">
                  <div class="flow-line" />
                </div>
              )}
            </>
          ))
        }
      </div>

      <!-- Content panels -->
      <div class="flow-content mt-0">
        {
          flowSteps.map((step, index) => (
            <div
              class={`flow-panel ${index === 0 ? 'flow-panel-active' : ''}`}
              data-panel={step.id}
            >
              <p class="flow-description">{step.description}</p>
            </div>
          ))
        }
      </div>
    </div>

    <!-- Problem Cards -->
    <div class="problem-cards">
      {
        items.map((item) => (
          <div class="problem-card" role="group" aria-label="Problem and response">
            <div class="stat-header">
              <span class="stat-value">{item.stat}</span>
              <span class="stat-note" aria-label="stat note">
                {item.statNote}
              </span>
            </div>

            <div class="sections-container">
              <div class="problem-section-card">
                <div class="eyebrow-label">Customer signal</div>
                <h3 class="card-title">{item.problem}</h3>
                <p class="card-desc">{item.problemDesc}</p>
              </div>

              <div class="solution-section-card">
                <div class="eyebrow-label">Concierge response</div>
                <h3 class="card-title">{item.solution}</h3>
                <p class="card-desc">{item.solutionDesc}</p>
              </div>
            </div>
          </div>
        ))
      }
    </div>

    <!-- Outcome -->
    <div class="outcome mb-8 sm:mb-24">
      <p class="outcome-text">
        A good return experience leads to <strong class="whitespace-nowrap"
          >3x more repeat purchases</strong
        >.
      </p>
      <a href="/roi" class="btn btn-primary"> Calculate your ROI </a>
    </div>
  </div>
</FullViewportSection>

<style>
  .problem-wrapper {
    max-width: 56rem;
    margin: 0 auto;
    padding-top: 2rem;
    padding-bottom: 4rem;
  }
  @media (min-width: 640px) {
    .problem-wrapper {
      padding-top: 0;
      padding-bottom: 0;
    }
  }

  /* Problem cards grid */
  .problem-cards {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    align-items: stretch;
  }
  @media (min-width: 768px) {
    .problem-cards {
      grid-template-columns: repeat(3, 1fr);
      gap: 1.25rem;
    }
  }

  .problem-card {
    display: flex;
    flex-direction: column;
    height: 100%;
    background-color: var(--color-surface-base);
    border: 1px solid var(--color-border);
    border-radius: 1rem;
    overflow: hidden;
    box-shadow:
      0 1px 2px rgba(15, 23, 42, 0.05),
      0 8px 20px rgba(15, 23, 42, 0.06);
    transition:
      box-shadow 200ms ease,
      transform 200ms ease,
      border-color 200ms ease;
  }

  .problem-card:hover {
    border-color: var(--color-border-hover);
    transform: translateY(-2px);
    box-shadow:
      0 2px 6px rgba(15, 23, 42, 0.06),
      0 14px 30px rgba(15, 23, 42, 0.1);
  }

  .stat-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1.25rem 1.25rem 1rem;
    background: linear-gradient(180deg, var(--color-surface-subtle), transparent 80%);
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1;
    color: var(--color-text-primary);
    letter-spacing: -0.02em;
  }

  .stat-note {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--color-text-secondary);
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    background-color: var(--color-surface-subtle);
    border: 1px solid var(--color-border-subtle);
  }

  .sections-container {
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  .problem-section-card,
  .solution-section-card {
    padding: 1rem 1.25rem 1.25rem;
  }

  .problem-section-card {
    background-color: transparent;
    min-height: 140px;
  }

  .solution-section-card {
    background-color: var(--color-surface-elevated);
    border-top: 1px solid var(--color-border);
    flex: 1;
  }

  .eyebrow-label {
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.075em;
    color: var(--color-text-tertiary);
    margin-bottom: 0.35rem;
  }

  .card-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: 0.25rem;
    letter-spacing: -0.01em;
  }

  .card-desc {
    font-size: 0.9rem;
    line-height: 1.65;
    color: var(--color-text-secondary);
  }

  /* Outcome callout */
  .outcome {
    margin-top: 3rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.25rem;
    background-color: var(--color-surface-subtle);
    padding: 2rem 1.5rem;
    border-radius: 0.75rem;
    border: 1px solid var(--color-border);
  }
  @media (min-width: 640px) {
    .outcome {
      margin-top: 4rem;
      flex-direction: row;
      justify-content: center;
      gap: 2rem;
      padding: 2rem 3rem;
    }
  }

  .outcome-text {
    font-size: 1rem;
    line-height: 1.5;
    color: var(--color-text-secondary);
    text-align: center;
  }
  .outcome-text strong {
    color: var(--color-text-primary);
    font-weight: 600;
  }
  @media (min-width: 640px) {
    .outcome-text {
      font-size: 1.125rem;
    }
  }
</style>

<script>
  const flowSteps = ['check-in', 'follow-up', 'resolve', 'route']
  let currentStep = 0
  let autoplayInterval: ReturnType<typeof setInterval> | null = null
  let isPaused = false
  const STEP_DURATION = 4000 // 4 seconds per step

  function setActiveStep(stepId: string) {
    currentStep = flowSteps.indexOf(stepId)

    // Update step buttons
    document.querySelectorAll('#problem-flow .flow-step').forEach((btn) => {
      const isActive = btn.getAttribute('data-step') === stepId
      btn.classList.toggle('flow-step-active', isActive)
    })

    // Update panels with animation
    document.querySelectorAll('#problem-flow .flow-panel').forEach((panel) => {
      const isActive = panel.getAttribute('data-panel') === stepId
      if (isActive) {
        panel.classList.add('flow-panel-active')
      } else {
        panel.classList.remove('flow-panel-active')
      }
    })

    // Update connector lines (fill up to current step)
    document.querySelectorAll('#problem-flow .flow-connector').forEach((connector, index) => {
      connector.classList.toggle('flow-connector-active', index < currentStep)
    })
  }

  function nextStep() {
    const nextIndex = (currentStep + 1) % flowSteps.length
    setActiveStep(flowSteps[nextIndex])
  }

  function startAutoplay() {
    if (autoplayInterval) clearInterval(autoplayInterval)
    autoplayInterval = setInterval(() => {
      if (!isPaused) nextStep()
    }, STEP_DURATION)
  }

  function init() {
    const flowContainer = document.getElementById('problem-flow')
    if (!flowContainer) return

    // Click handlers for step buttons
    flowContainer.querySelectorAll('.flow-step').forEach((btn) => {
      btn.addEventListener('click', () => {
        const stepId = btn.getAttribute('data-step')
        if (stepId) {
          setActiveStep(stepId)
          // Reset autoplay timer on click
          startAutoplay()
        }
      })
    })

    // Pause on hover
    flowContainer.addEventListener('mouseenter', () => {
      isPaused = true
    })
    flowContainer.addEventListener('mouseleave', () => {
      isPaused = false
    })

    // Start autoplay
    startAutoplay()
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init)
  } else {
    init()
  }
</script>
