---
/**
 * ProblemSection — Variant 1
 * Signal → Concierge response (keeps stats, improves tone + exchange framing)
 */
import FullViewportSection from '@layouts/FullViewportSection.astro'
import HeroIcons from '@components/icons/HeroIcons.astro'

interface Props {
  className?: string
}

const { className = '' } = Astro.props

const flowSteps = [
  {
    id: 'check-in',
    label: 'Check in',
    description: 'A proactive text that feels like a real associate.',
    icon: 'chat' as const,
  },
  {
    id: 'follow-up',
    label: 'Follow up',
    description: "If they haven't tried it yet, no problem. We'll reach out again later.",
    icon: 'calendar' as const,
  },
  {
    id: 'resolve',
    label: 'Resolve',
    description:
      'Support that saves the sale: fit & styling guidance, plus tailored exchange recommendations.',
    icon: 'camera' as const,
  },
  {
    id: 'route',
    label: 'Return route',
    description: 'If a return is needed, use photos to decide: restock, rework, or keep‑it.',
    icon: 'route' as const,
  },
]
---

<FullViewportSection class={className} bg="bg-surface-subtle">
  <div id="problem-section" class="problem-wrapper">
    <!-- Header -->
    <div class="text-center mb-10 sm:mb-14 pt-8 sm:pt-24">
      <h2 class="section-title mb-4">Customers love engaging with Return Signals</h2>
      <p class="text-lg sm:text-xl text-primary leading-relaxed max-w-3xl mx-auto">
        Real results from our customers.
      </p>
    </div>

    <!-- Interactive Flow -->
    <div class="mb-10 sm:mb-14 px-4" id="problem-flow">
      <!-- Flow Navigation -->
      <div class="flow-container">
        {
          flowSteps.map((step, index) => (
            <>
              <button
                class={`flow-step ${index === 0 ? 'flow-step-active' : ''}`}
                data-step={step.id}
                aria-label={`View ${step.label} step`}
              >
                <div class="flow-icon">
                  <HeroIcons name={step.icon} />
                </div>
                <span class="flow-label">{step.label}</span>
              </button>
              {index < flowSteps.length - 1 && (
                <div class="flow-connector">
                  <div class="flow-line" />
                </div>
              )}
            </>
          ))
        }
      </div>

      <!-- Content panels -->
      <div class="flow-content mt-0">
        {
          flowSteps.map((step, index) => (
            <div
              class={`flow-panel ${index === 0 ? 'flow-panel-active' : ''}`}
              data-panel={step.id}
            >
              <p class="flow-description">{step.description}</p>
            </div>
          ))
        }
      </div>
    </div>

    <!-- Pilot Results Cards -->
    <div class="results-cards">
      <!-- Happy Customers Reply Rate -->
      <div class="result-card">
        <div class="result-stat">
          <span class="result-value">60%</span>
          <span class="result-label">reply rate</span>
        </div>
        <div class="result-detail">
          <p class="result-description">
            Customers happy with their order still engaged with our check-ins.
          </p>
        </div>
      </div>

      <!-- Return Customers Reply Rate -->
      <div class="result-card">
        <div class="result-stat">
          <span class="result-value">78%</span>
          <span class="result-label">reply rate</span>
        </div>
        <div class="result-detail">
          <p class="result-description">
            Customers with issues engaged, letting us offer exchanges.
          </p>
        </div>
      </div>

      <!-- Exchange Rate Card -->
      <div class="result-card">
        <div class="result-stat">
          <span class="result-value">71%</span>
          <span class="result-label">exchange rate</span>
        </div>
        <div class="result-detail">
          <p class="result-description">Of return requests were converted into exchanges.</p>
        </div>
      </div>
    </div>

    <!-- Outcome -->
    <div class="outcome mb-8 sm:mb-24">
      <p class="outcome-text">
        A good return experience leads to <strong class="whitespace-nowrap"
          >3x more repeat purchases</strong
        >.
      </p>
      <a href="/roi" class="btn btn-primary"> Calculate your ROI </a>
    </div>
  </div>
</FullViewportSection>

<style>
  .problem-wrapper {
    max-width: 56rem;
    margin: 0 auto;
    padding-top: 2rem;
    padding-bottom: 4rem;
  }
  @media (min-width: 640px) {
    .problem-wrapper {
      padding-top: 0;
      padding-bottom: 0;
    }
  }

  /* Results Cards Grid */
  .results-cards {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }
  @media (min-width: 768px) {
    .results-cards {
      grid-template-columns: repeat(3, 1fr);
      gap: 1.25rem;
    }
  }

  .result-card {
    display: flex;
    flex-direction: column;
    height: 100%;
    background-color: var(--color-surface-base);
    border: 1px solid var(--color-border);
    border-radius: 1rem;
    overflow: hidden;
    box-shadow:
      0 1px 2px rgba(15, 23, 42, 0.05),
      0 8px 20px rgba(15, 23, 42, 0.06);
    transition:
      box-shadow 200ms ease,
      transform 200ms ease,
      border-color 200ms ease;
  }

  .result-card:hover {
    border-color: var(--color-border-hover);
    transform: translateY(-2px);
    box-shadow:
      0 2px 6px rgba(15, 23, 42, 0.06),
      0 14px 30px rgba(15, 23, 42, 0.1);
  }

  .result-stat {
    display: flex;
    align-items: baseline;
    gap: 0.625rem;
    padding: 1.5rem 1.5rem 1rem;
    background: linear-gradient(180deg, var(--color-surface-subtle), transparent 80%);
  }

  .result-value {
    font-size: 2.5rem;
    font-weight: 700;
    line-height: 1;
    color: var(--color-text-primary);
    letter-spacing: -0.02em;
  }

  .result-label {
    font-size: 1rem;
    font-weight: 500;
    color: var(--color-text-secondary);
  }

  .result-detail {
    padding: 0 1.5rem 1.5rem;
    flex: 1;
  }

  .result-description {
    font-size: 0.9375rem;
    line-height: 1.6;
    color: var(--color-text-tertiary);
  }

  /* Outcome callout */
  .outcome {
    margin-top: 3rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.25rem;
    background-color: var(--color-surface-base);
    padding: 2rem 1.5rem;
    border-radius: 1rem;
    border: 1px solid var(--color-border);
  }
  @media (min-width: 640px) {
    .outcome {
      margin-top: 2.5rem;
      flex-direction: row;
      justify-content: center;
      gap: 2rem;
      padding: 1.75rem 2.5rem;
    }
  }

  .outcome-text {
    font-size: 1rem;
    line-height: 1.5;
    color: var(--color-text-secondary);
    text-align: center;
  }
  .outcome-text strong {
    color: var(--color-text-primary);
    font-weight: 600;
  }
  @media (min-width: 640px) {
    .outcome-text {
      font-size: 1.0625rem;
    }
  }
</style>

<script>
  const flowSteps = ['check-in', 'follow-up', 'resolve', 'route']
  let currentStep = 0
  let autoplayInterval: ReturnType<typeof setInterval> | null = null
  let isPaused = false
  const STEP_DURATION = 4000 // 4 seconds per step

  function setActiveStep(stepId: string) {
    currentStep = flowSteps.indexOf(stepId)

    // Update step buttons
    document.querySelectorAll('#problem-flow .flow-step').forEach((btn) => {
      const isActive = btn.getAttribute('data-step') === stepId
      btn.classList.toggle('flow-step-active', isActive)
    })

    // Update panels with animation
    document.querySelectorAll('#problem-flow .flow-panel').forEach((panel) => {
      const isActive = panel.getAttribute('data-panel') === stepId
      if (isActive) {
        panel.classList.add('flow-panel-active')
      } else {
        panel.classList.remove('flow-panel-active')
      }
    })

    // Update connector lines (fill up to current step)
    document.querySelectorAll('#problem-flow .flow-connector').forEach((connector, index) => {
      connector.classList.toggle('flow-connector-active', index < currentStep)
    })
  }

  function nextStep() {
    const nextIndex = (currentStep + 1) % flowSteps.length
    setActiveStep(flowSteps[nextIndex])
  }

  function startAutoplay() {
    if (autoplayInterval) clearInterval(autoplayInterval)
    autoplayInterval = setInterval(() => {
      if (!isPaused) nextStep()
    }, STEP_DURATION)
  }

  function init() {
    const flowContainer = document.getElementById('problem-flow')
    if (!flowContainer) return

    // Click handlers for step buttons
    flowContainer.querySelectorAll('.flow-step').forEach((btn) => {
      btn.addEventListener('click', () => {
        const stepId = btn.getAttribute('data-step')
        if (stepId) {
          setActiveStep(stepId)
          // Reset autoplay timer on click
          startAutoplay()
        }
      })
    })

    // Pause on hover
    flowContainer.addEventListener('mouseenter', () => {
      isPaused = true
    })
    flowContainer.addEventListener('mouseleave', () => {
      isPaused = false
    })

    // Start autoplay
    startAutoplay()
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init)
  } else {
    init()
  }
</script>
