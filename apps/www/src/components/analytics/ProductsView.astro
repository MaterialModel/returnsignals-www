---
/**
 * Products View - SKU-level intelligence with NL query
 */
---

<div class="products-view">
  <!-- Search/Query Interface -->
  <div class="mb-6 bg-surface-base border-2 border-accent-primary/30 rounded-lg p-4">
    <div class="flex items-center gap-3">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5 text-accent-primary flex-shrink-0"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
      <input
        type="text"
        placeholder="Ask about product issues..."
        class="nl-query-input flex-1 text-sm text-primary placeholder-tertiary bg-transparent outline-none"
        readonly
        value=""
        data-full-query="What are common fit complaints for the wrap dress?"
      />
    </div>
  </div>

  <!-- Query Answer (initially hidden, will animate in) -->
  <div
    class="nl-answer-container mb-6 opacity-0 max-h-0 overflow-hidden transition-all duration-500"
  >
    <div class="bg-accent-primary/5 border border-accent-primary/20 rounded-lg p-5">
      <div class="flex items-start gap-3 mb-3">
        <div
          class="w-8 h-8 rounded-lg bg-accent-primary/10 flex items-center justify-center flex-shrink-0"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 text-accent-primary"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
            ></path>
          </svg>
        </div>
        <div class="flex-1">
          <h4 class="text-sm font-semibold text-primary mb-3">Top fit issues customers report:</h4>
          <div class="space-y-2">
            <div
              class="answer-item clickable-answer opacity-0 transform translate-x-2 transition-all duration-300 cursor-pointer hover:bg-accent-primary/5 -mx-2 px-2 py-2 rounded"
              data-issue="neckline"
            >
              <div class="flex items-start gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-accent-primary mt-1.5 flex-shrink-0"
                ></span>
                <div class="flex-1">
                  <span class="text-sm font-medium text-primary">Neckline gapping</span>
                  <span class="text-sm text-secondary"> — 38% of complaints</span>
                  <div class="text-xs text-tertiary mt-0.5">
                    Usually fixable with styling tips • Click to see examples
                  </div>
                </div>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4 text-accent-primary flex-shrink-0 mt-1"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"></path>
                </svg>
              </div>
            </div>
            <div
              class="answer-item clickable-answer opacity-0 transform translate-x-2 transition-all duration-300 cursor-pointer hover:bg-accent-primary/5 -mx-2 px-2 py-2 rounded"
              data-issue="waist"
            >
              <div class="flex items-start gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-accent-primary mt-1.5 flex-shrink-0"
                ></span>
                <div class="flex-1">
                  <span class="text-sm font-medium text-primary">Waist tie too short</span>
                  <span class="text-sm text-secondary"> — 24% of complaints</span>
                  <div class="text-xs text-tertiary mt-0.5">
                    Size up recommendation • Click to see examples
                  </div>
                </div>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4 text-accent-primary flex-shrink-0 mt-1"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"></path>
                </svg>
              </div>
            </div>
            <div
              class="answer-item clickable-answer opacity-0 transform translate-x-2 transition-all duration-300 cursor-pointer hover:bg-accent-primary/5 -mx-2 px-2 py-2 rounded"
              data-issue="hem"
            >
              <div class="flex items-start gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-accent-primary mt-1.5 flex-shrink-0"
                ></span>
                <div class="flex-1">
                  <span class="text-sm font-medium text-primary">Hem length concerns</span>
                  <span class="text-sm text-secondary"> — 18% of complaints</span>
                  <div class="text-xs text-tertiary mt-0.5">
                    Expectation mismatch • Click to see examples
                  </div>
                </div>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4 text-accent-primary flex-shrink-0 mt-1"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"></path>
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Conversations Drill-down (initially hidden) -->
  <div
    class="conversations-drilldown mb-6 opacity-0 max-h-0 overflow-hidden transition-all duration-500"
  >
    <div class="bg-surface-base border border-border rounded-lg p-5">
      <div class="flex items-center justify-between mb-4">
        <h4 class="text-sm font-semibold text-primary">
          Recent conversations about neckline gapping
        </h4>
        <button class="close-drilldown text-xs text-accent-primary hover:underline cursor-pointer"
          >Close</button
        >
      </div>
      <div class="space-y-2">
        <div
          class="conversation-summary p-3 bg-surface-subtle rounded-lg hover:bg-surface-elevated transition-colors cursor-pointer border border-transparent hover:border-accent-primary/30"
        >
          <div class="flex items-start justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="text-sm font-medium text-primary">Jacky R.</span>
              <span class="text-xs text-tertiary">• 2 days ago</span>
            </div>
            <span class="px-2 py-0.5 text-xs bg-accent-success/10 text-accent-success rounded"
              >Resolved</span
            >
          </div>
          <p class="text-xs text-secondary mb-2">
            "Neckline gaps more than expected" → Provided styling tip with fashion tape
          </p>
          <div class="text-xs text-accent-primary font-medium">Tap to see full chat log →</div>
        </div>
        <div
          class="conversation-summary p-3 bg-surface-subtle rounded-lg hover:bg-surface-elevated transition-colors cursor-pointer border border-transparent hover:border-accent-primary/30"
        >
          <div class="flex items-start justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="text-sm font-medium text-primary">Emma S.</span>
              <span class="text-xs text-tertiary">• 5 days ago</span>
            </div>
            <span class="px-2 py-0.5 text-xs bg-accent-success/10 text-accent-success rounded"
              >Resolved</span
            >
          </div>
          <p class="text-xs text-secondary mb-2">
            "Worried about neckline fit" → Demonstrated proper tying technique
          </p>
          <div class="text-xs text-accent-primary font-medium">Tap to see full chat log →</div>
        </div>
        <div
          class="conversation-summary p-3 bg-surface-subtle rounded-lg hover:bg-surface-elevated transition-colors cursor-pointer border border-transparent hover:border-accent-primary/30"
        >
          <div class="flex items-start justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="text-sm font-medium text-primary">Lisa M.</span>
              <span class="text-xs text-tertiary">• 1 week ago</span>
            </div>
            <span class="px-2 py-0.5 text-xs bg-accent-success-subtle text-accent-success rounded"
              >Exchange</span
            >
          </div>
          <p class="text-xs text-secondary mb-2">
            "Won't stay in place" → Size issue, exchanged for smaller
          </p>
          <div class="text-xs text-accent-primary font-medium">Tap to see full chat log →</div>
        </div>
        <div
          class="conversation-summary p-3 bg-surface-subtle rounded-lg hover:bg-surface-elevated transition-colors cursor-pointer border border-transparent hover:border-accent-primary/30"
        >
          <div class="flex items-start justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="text-sm font-medium text-primary">Ana P.</span>
              <span class="text-xs text-tertiary">• 1 week ago</span>
            </div>
            <span class="px-2 py-0.5 text-xs bg-accent-success/10 text-accent-success rounded"
              >Resolved</span
            >
          </div>
          <p class="text-xs text-secondary mb-2">
            "Gaps when I move" → Inner tie adjustment worked
          </p>
          <div class="text-xs text-accent-primary font-medium">Tap to see full chat log →</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Problem Products Table -->
  <div class="bg-surface-base border border-border rounded-lg p-4 sm:p-6 mb-6">
    <h3 class="text-sm font-semibold text-primary mb-4">Top Problem Products</h3>

    <!-- Mobile: Card layout -->
    <div class="sm:hidden space-y-3">
      <div class="product-card p-3 bg-surface-subtle rounded-lg border border-border">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="font-medium text-primary text-sm">Wrap Dress</div>
            <div class="text-xs text-tertiary">Women's • Apparel</div>
          </div>
          <span class="px-2 py-1 text-xs font-medium bg-amber-500/10 text-amber-600 rounded"
            >24%</span
          >
        </div>
        <div class="text-xs text-secondary">187 complaints • Neckline gapping (38%)</div>
      </div>
      <div class="product-card p-3 bg-surface-subtle rounded-lg border border-border">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="font-medium text-primary text-sm">Classic Tee</div>
            <div class="text-xs text-tertiary">Men's • Basic</div>
          </div>
          <span class="px-2 py-1 text-xs font-medium bg-red-500/10 text-red-600 rounded">31%</span>
        </div>
        <div class="text-xs text-secondary">156 complaints • Shrinkage (42%)</div>
      </div>
      <div class="product-card p-3 bg-surface-subtle rounded-lg border border-border">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="font-medium text-primary text-sm">Athletic Leggings</div>
            <div class="text-xs text-tertiary">Women's • Activewear</div>
          </div>
          <span class="px-2 py-1 text-xs font-medium bg-amber-500/10 text-amber-600 rounded"
            >19%</span
          >
        </div>
        <div class="text-xs text-secondary">143 complaints • Seam quality (29%)</div>
      </div>
    </div>

    <!-- Desktop: Table layout -->
    <div class="hidden sm:block overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="border-b border-border">
          <tr>
            <th class="text-left py-2 px-2 font-medium text-secondary">Product</th>
            <th class="text-right py-2 px-2 font-medium text-secondary">Complaints</th>
            <th class="text-right py-2 px-2 font-medium text-secondary">Top Issue</th>
            <th class="text-right py-2 px-2 font-medium text-secondary">Return Rate</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-border">
          <tr class="hover:bg-surface-subtle cursor-pointer transition-colors">
            <td class="py-3 px-2">
              <div class="font-medium text-primary">Wrap Dress</div>
              <div class="text-xs text-tertiary">Women's • Apparel</div>
            </td>
            <td class="text-right py-3 px-2 font-semibold text-primary">187</td>
            <td class="text-right py-3 px-2 text-secondary">Neckline gapping (38%)</td>
            <td class="text-right py-3 px-2">
              <span class="px-2 py-1 text-xs font-medium bg-amber-500/10 text-amber-600 rounded"
                >24%</span
              >
            </td>
          </tr>
          <tr class="hover:bg-surface-subtle cursor-pointer transition-colors">
            <td class="py-3 px-2">
              <div class="font-medium text-primary">Classic Tee</div>
              <div class="text-xs text-tertiary">Men's • Basic</div>
            </td>
            <td class="text-right py-3 px-2 font-semibold text-primary">156</td>
            <td class="text-right py-3 px-2 text-secondary">Shrinkage (42%)</td>
            <td class="text-right py-3 px-2">
              <span class="px-2 py-1 text-xs font-medium bg-red-500/10 text-red-600 rounded"
                >31%</span
              >
            </td>
          </tr>
          <tr class="hover:bg-surface-subtle cursor-pointer transition-colors">
            <td class="py-3 px-2">
              <div class="font-medium text-primary">Athletic Leggings</div>
              <div class="text-xs text-tertiary">Women's • Activewear</div>
            </td>
            <td class="text-right py-3 px-2 font-semibold text-primary">143</td>
            <td class="text-right py-3 px-2 text-secondary">Seam quality (29%)</td>
            <td class="text-right py-3 px-2">
              <span class="px-2 py-1 text-xs font-medium bg-amber-500/10 text-amber-600 rounded"
                >19%</span
              >
            </td>
          </tr>
          <tr class="hover:bg-surface-subtle cursor-pointer transition-colors">
            <td class="py-3 px-2">
              <div class="font-medium text-primary">Gym Shirt</div>
              <div class="text-xs text-tertiary">Men's • Activewear</div>
            </td>
            <td class="text-right py-3 px-2 font-semibold text-primary">98</td>
            <td class="text-right py-3 px-2 text-secondary">Fit issues (35%)</td>
            <td class="text-right py-3 px-2">
              <span
                class="px-2 py-1 text-xs font-medium bg-accent-success/10 text-accent-success rounded"
                >12%</span
              >
            </td>
          </tr>
          <tr class="hover:bg-surface-subtle cursor-pointer transition-colors">
            <td class="py-3 px-2">
              <div class="font-medium text-primary">Running Shorts</div>
              <div class="text-xs text-tertiary">Unisex • Activewear</div>
            </td>
            <td class="text-right py-3 px-2 font-semibold text-primary">87</td>
            <td class="text-right py-3 px-2 text-secondary">Length concerns (41%)</td>
            <td class="text-right py-3 px-2">
              <span
                class="px-2 py-1 text-xs font-medium bg-accent-success/10 text-accent-success rounded"
                >15%</span
              >
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Issue Breakdown & Trending -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
    <div class="bg-surface-base border border-border rounded-lg p-4 sm:p-6">
      <h3 class="text-sm font-semibold text-primary mb-4">Issues by Category</h3>
      <div class="space-y-3">
        <div>
          <div class="flex items-center justify-between mb-1">
            <span class="text-sm text-primary">Fit & Sizing</span>
            <span class="text-sm font-bold text-primary">342 (38%)</span>
          </div>
          <div class="h-2 bg-surface-elevated rounded-full overflow-hidden">
            <div class="h-full bg-accent-primary rounded-full" style="width: 38%"></div>
          </div>
        </div>
        <div>
          <div class="flex items-center justify-between mb-1">
            <span class="text-sm text-primary">Quality & Defects</span>
            <span class="text-sm font-bold text-primary">287 (32%)</span>
          </div>
          <div class="h-2 bg-surface-elevated rounded-full overflow-hidden">
            <div class="h-full bg-amber-500 rounded-full" style="width: 32%"></div>
          </div>
        </div>
        <div>
          <div class="flex items-center justify-between mb-1">
            <span class="text-sm text-primary">Expectations Mismatch</span>
            <span class="text-sm font-bold text-primary">178 (20%)</span>
          </div>
          <div class="h-2 bg-surface-elevated rounded-full overflow-hidden">
            <div class="h-full bg-accent-success rounded-full" style="width: 20%"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-surface-base border border-border rounded-lg p-4 sm:p-6">
      <h3 class="text-sm font-semibold text-primary mb-4">Trending This Week</h3>
      <div class="space-y-3">
        <div class="flex items-start gap-2">
          <span class="text-xs font-bold text-red-500 mt-0.5">↑</span>
          <div class="flex-1">
            <div class="text-sm font-medium text-primary">Shrinkage complaints</div>
            <div class="text-xs text-secondary">+23% for Classic Tee</div>
          </div>
        </div>
        <div class="flex items-start gap-2">
          <span class="text-xs font-bold text-red-500 mt-0.5">↑</span>
          <div class="flex-1">
            <div class="text-sm font-medium text-primary">Seam quality issues</div>
            <div class="text-xs text-secondary">+18% for Athletic Leggings</div>
          </div>
        </div>
        <div class="flex items-start gap-2">
          <span class="text-xs font-bold text-accent-success mt-0.5">↓</span>
          <div class="flex-1">
            <div class="text-sm font-medium text-primary">Neckline gapping</div>
            <div class="text-xs text-secondary">-12% for Wrap Dress (guidance working!)</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Typing cursor effect */
  .nl-query-input.typing::after {
    content: '|';
    animation: blink 1s step-end infinite;
    margin-left: 2px;
    color: rgb(15, 23, 42);
  }

  @keyframes blink {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0;
    }
  }
</style>

<script>
  // Products view NL query animation
  document.addEventListener('DOMContentLoaded', () => {
    const productsView = document.querySelector('.products-view')
    if (!productsView) return

    let hasAnimated = false

    // Observer for when products view becomes active
    const observer = new MutationObserver(() => {
      const isActive = productsView.closest('.view-content')?.classList.contains('active')
      if (isActive && !hasAnimated) {
        hasAnimated = true
        animateProductsQuery()
      }
    })

    const viewContent = productsView.closest('.view-content')
    if (viewContent) {
      observer.observe(viewContent, {
        attributes: true,
        attributeFilter: ['class'],
      })
    }

    async function animateProductsQuery() {
      await wait(300)

      // Type the question
      const input = productsView.querySelector('.nl-query-input') as HTMLInputElement
      if (input) {
        const query = input.getAttribute('data-full-query') || ''
        input.classList.add('typing')
        await typeText(input, query)
        input.classList.remove('typing')
      }

      await wait(400)

      // Show answer container
      const answerContainer = productsView.querySelector('.nl-answer-container') as HTMLElement
      if (answerContainer) {
        answerContainer.style.opacity = '1'
        answerContainer.style.maxHeight = '500px'
      }

      await wait(300)

      // Stagger reveal answer items
      const answerItems = Array.from(productsView.querySelectorAll('.answer-item')) as HTMLElement[]
      for (const item of answerItems) {
        item.style.opacity = '1'
        item.style.transform = 'translateX(0)'
        await wait(150)
      }

      // Add click handlers for drill-down
      const clickableAnswers = Array.from(
        productsView.querySelectorAll('.clickable-answer')
      ) as HTMLElement[]
      const drilldown = productsView.querySelector('.conversations-drilldown') as HTMLElement
      const closeBtn = productsView.querySelector('.close-drilldown') as HTMLElement

      clickableAnswers.forEach((answer) => {
        answer.addEventListener('click', () => {
          if (drilldown) {
            drilldown.style.opacity = '1'
            drilldown.style.maxHeight = '600px'
          }
        })
      })

      if (closeBtn && drilldown) {
        closeBtn.addEventListener('click', () => {
          drilldown.style.opacity = '0'
          drilldown.style.maxHeight = '0'
        })
      }
    }

    function typeText(input: HTMLInputElement, text: string) {
      return new Promise<void>((resolve) => {
        let i = 0
        const interval = setInterval(() => {
          input.value = text.slice(0, i + 1)
          i++
          if (i > text.length) {
            clearInterval(interval)
            resolve()
          }
        }, 50)
      })
    }

    function wait(ms: number) {
      return new Promise((resolve) => setTimeout(resolve, ms))
    }
  })
</script>
