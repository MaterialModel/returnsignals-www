---
/**
 * ParallaxContainer
 *
 * Background image with subtle parallax effect for Hero + Problem sections
 */

interface Props {
  className?: string;
  parallaxFactor?: number;
  parallaxMaxOffset?: number;
}

const {
  className = "",
  parallaxFactor = 0.06,
  parallaxMaxOffset = 120,
} = Astro.props;

const parallaxId = `parallax-${Math.random().toString(36).substring(2, 11)}`;
---

<div class={`relative ${className}`}>
  <!-- Sticky parallax background that spans viewport while container scrolls -->
  <div class="absolute inset-0 -z-10">
    <!-- 
      FIX 1: Changed 'h-screen' to 'h-[100dvh]' 
      'dvh' (dynamic viewport height) resizes when the mobile address bar retracts.
    -->
    <div class="sticky top-0 h-[100dvh] w-full overflow-hidden">
      <!-- Moving layer is taller than viewport to prevent top/bottom gaps -->
      <div
        id={parallaxId}
        class="relative w-full will-change-transform"
        style={`
          /* FIX 2: Changed 100vh to 100dvh in calculation to match parent height */
          height: calc(100dvh + ${parallaxMaxOffset * 2}px); 
          transform: translate3d(0, ${-parallaxMaxOffset}px, 0);
        `}
      >
        <picture>
          <source
            media="(min-width: 640px)"
            srcset="/images/background/background-wide.jpg"
          />
          <img
            src="/images/background/background-mobile.jpg"
            alt=""
            class="absolute inset-0 h-full w-full object-cover object-center"
          />
        </picture>
        <!-- Subtle top haze for readability -->
        <div
          class="absolute inset-0 bg-gradient-to-b from-white/15 via-white/10 to-transparent"
        >
        </div>
      </div>
    </div>
    <!-- Smooth transition to white at the end of the parallax group -->
    <div
      class="pointer-events-none absolute bottom-0 left-0 right-0 h-24 sm:h-32 bg-gradient-to-b from-transparent to-white"
    >
    </div>
  </div>

  <!-- Content slot -->
  <slot />
</div>

<script define:vars={{ parallaxId, parallaxFactor, parallaxMaxOffset }}>
  // Subtle parallax effect
  const bg = document.getElementById(parallaxId);
  const reduceMotion = window.matchMedia("(prefers-reduced-motion: reduce)");

  if (bg && !(reduceMotion && reduceMotion.matches)) {
    let ticking = false;
    const baseOffset = -parallaxMaxOffset;
    const onScroll = () => {
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(() => {
        const y = window.scrollY || 0;
        const offset = Math.max(
          -parallaxMaxOffset,
          Math.min(parallaxMaxOffset, y * parallaxFactor),
        );
        bg.style.transform = `translate3d(0, ${baseOffset + offset}px, 0)`;
        ticking = false;
      });
    };
    window.addEventListener("scroll", onScroll, { passive: true });
    // Also update on resize to handle address bar changes more robustly
    window.addEventListener("resize", onScroll, { passive: true });
    onScroll();
  }
</script>
