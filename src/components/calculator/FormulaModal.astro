---
import { formulas, inputVariables } from "./formulas";

// Helper to get description (supports both plain and HTML)
type Variable = {
  html: string;
  description?: string;
  descriptionHtml?: string;
};
const getDescription = (v: Variable) =>
  v.descriptionHtml || v.description || "";
const hasHtmlDescription = (v: Variable) => !!v.descriptionHtml;
---

<!-- Modal Overlay (renders at root level) -->
<div
  id="formulaModal"
  class="hidden fixed inset-0 z-[100] overflow-y-auto"
  aria-labelledby="modal-title"
  role="dialog"
  aria-modal="true"
>
  <!-- Background overlay -->
  <div class="fixed inset-0 bg-black/60 transition-opacity" aria-hidden="true">
  </div>

  <!-- Modal panel -->
  <div class="flex min-h-full items-center justify-center p-4">
    <div
      class="relative transform overflow-hidden rounded-lg bg-surface-base border border-border shadow-xl transition-all w-full max-w-4xl"
    >
      <!-- Header -->
      <div
        class="px-6 py-4 border-b border-border flex items-center justify-between"
      >
        <h2 class="text-xl font-bold text-primary" id="modal-title">
          How We Calculate ROI
        </h2>
        <button
          id="closeModalButton"
          class="text-tertiary hover:text-primary transition-colors"
          aria-label="Close dialog"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- Content -->
      <div class="px-6 py-6 max-h-[70vh] overflow-y-auto" id="formulaContent">
        <!-- Input Variables Section -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold text-primary mb-4">
            Input Variables
          </h3>
          <p class="text-sm text-secondary mb-4">
            These are the values you enter in the calculator. Understanding them
            helps interpret the results.
          </p>

          <!-- Business Metrics -->
          <div class="mb-4">
            <h4 class="text-sm font-semibold text-accent-primary mb-2">
              Business Metrics
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
              {
                inputVariables.businessMetrics.map((v) => (
                  <div class="flex items-baseline gap-2">
                    <span
                      class="font-mono text-accent-primary font-semibold min-w-[60px]"
                      set:html={v.html}
                    />
                    <span class="text-secondary">{v.description}</span>
                  </div>
                ))
              }
            </div>
          </div>

          <!-- Costs -->
          <div class="mb-4">
            <h4 class="text-sm font-semibold text-accent-primary mb-2">
              Costs
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
              {
                inputVariables.costs.map((v) => (
                  <div class="flex items-baseline gap-2">
                    <span
                      class="font-mono text-accent-primary font-semibold min-w-[60px]"
                      set:html={v.html}
                    />
                    {hasHtmlDescription(v) ? (
                      <span
                        class="text-secondary"
                        set:html={getDescription(v)}
                      />
                    ) : (
                      <span class="text-secondary">{v.description}</span>
                    )}
                  </div>
                ))
              }
            </div>
          </div>

          <!-- Return Rates -->
          <div class="mb-4">
            <h4 class="text-sm font-semibold text-accent-primary mb-2">
              Return Rates
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
              {
                inputVariables.returnRates.map((v) => (
                  <div class="flex items-baseline gap-2">
                    <span
                      class="font-mono text-accent-primary font-semibold min-w-[60px]"
                      set:html={v.html}
                    />
                    <span class="text-secondary">{v.description}</span>
                  </div>
                ))
              }
            </div>
          </div>

          <!-- Impact Metrics -->
          <div>
            <h4 class="text-sm font-semibold text-accent-primary mb-2">
              Return Signals Impact
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
              {
                inputVariables.impact.map((v) => (
                  <div class="flex items-baseline gap-2">
                    <span
                      class="font-mono text-accent-primary font-semibold min-w-[60px]"
                      set:html={v.html}
                    />
                    <span class="text-secondary">{v.description}</span>
                  </div>
                ))
              }
            </div>
          </div>
        </div>

        <!-- Divider -->
        <div class="border-t border-border mb-8"></div>

        <!-- Step 1: Eligible Returns -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold text-primary mb-2">
            {formulas.eligibleReturns.title}
          </h3>
          <p class="text-sm text-secondary mb-3">
            {formulas.eligibleReturns.description}
          </p>

          <div class="bg-surface-subtle p-4 rounded-lg mb-3">
            <div
              class="text-base"
              set:html={`\\[${formulas.eligibleReturns.mainFormula}\\]`}
            />
          </div>

          <div class="space-y-2 text-sm text-secondary mb-3">
            <p class="font-medium text-primary">Where:</p>
            {
              formulas.eligibleReturns.subFormulas.map((sf) => (
                <div class="ml-4 flex flex-col gap-1">
                  <span set:html={`\\(${sf.latex}\\)`} />
                  <span class="text-tertiary text-xs ml-4">
                    {sf.description}
                  </span>
                </div>
              ))
            }
          </div>

          <div class="bg-accent-primary/5 border-l-2 border-accent-primary p-3">
            <p class="text-sm text-secondary italic">
              <strong class="text-primary not-italic">Why?</strong>
              {formulas.eligibleReturns.intuition}
            </p>
          </div>
        </div>

        <!-- Step 2: Exchange Value -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold text-primary mb-2">
            {formulas.exchangeValue.title}
          </h3>
          <p class="text-sm text-secondary mb-3">
            {formulas.exchangeValue.description}
          </p>

          <div class="bg-surface-subtle p-4 rounded-lg mb-3">
            <div
              class="text-base"
              set:html={`\\[${formulas.exchangeValue.mainFormula}\\]`}
            />
          </div>

          <div class="space-y-2 text-sm text-secondary mb-3">
            <p class="font-medium text-primary">Where:</p>
            {
              formulas.exchangeValue.subFormulas.map((sf) => (
                <div class="ml-4 flex flex-col gap-1">
                  <span set:html={`\\(${sf.latex}\\)`} />
                  <span class="text-tertiary text-xs ml-4">
                    {sf.description}
                  </span>
                </div>
              ))
            }
          </div>

          <div class="bg-accent-primary/5 border-l-2 border-accent-primary p-3">
            <p class="text-sm text-secondary mb-2">
              <strong class="text-primary">Why this formula works:</strong>
            </p>
            <ul class="text-sm text-secondary space-y-1 ml-4">
              {
                formulas.exchangeValue.intuitionBulletsHtml?.map((bullet) => (
                  <li class="flex items-start gap-2">
                    <span class="text-accent-primary">+</span>
                    <span set:html={bullet} />
                  </li>
                ))
              }
            </ul>
          </div>
        </div>

        <!-- Step 3: Keep Item Value -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold text-primary mb-2">
            {formulas.keepValue.title}
          </h3>
          <p class="text-sm text-secondary mb-3">
            {formulas.keepValue.description}
          </p>

          <div class="bg-surface-subtle p-4 rounded-lg mb-3">
            <div
              class="text-base"
              set:html={`\\[${formulas.keepValue.mainFormula}\\]`}
            />
          </div>

          <div class="space-y-2 text-sm text-secondary mb-3">
            <p class="font-medium text-primary">Where:</p>
            {
              formulas.keepValue.subFormulas.map((sf) => (
                <div class="ml-4 flex flex-col gap-1">
                  <span set:html={`\\(${sf.latex}\\)`} />
                  <span class="text-tertiary text-xs ml-4">
                    {sf.description}
                  </span>
                </div>
              ))
            }
          </div>

          <div class="bg-accent-primary/5 border-l-2 border-accent-primary p-3">
            <p class="text-sm text-secondary mb-2">
              <strong class="text-primary">Why this formula works:</strong>
            </p>
            <ul class="text-sm text-secondary space-y-1 ml-4">
              {
                formulas.keepValue.intuitionBulletsHtml?.map((bullet) => (
                  <li class="flex items-start gap-2">
                    <span class="text-accent-primary">+</span>
                    <span set:html={bullet} />
                  </li>
                ))
              }
            </ul>
          </div>
        </div>

        <!-- Step 4: Retention Value -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold text-primary mb-2">
            {formulas.retentionValue.title}
          </h3>
          <p class="text-sm text-secondary mb-3">
            {formulas.retentionValue.description}
          </p>

          <div class="bg-surface-subtle p-4 rounded-lg mb-3">
            <div
              class="text-base"
              set:html={`\\[${formulas.retentionValue.mainFormula}\\]`}
            />
          </div>

          <div class="space-y-2 text-sm text-secondary mb-3">
            <p class="font-medium text-primary">Where:</p>
            {
              formulas.retentionValue.subFormulas.map((sf) => (
                <div class="ml-4 flex flex-col gap-1">
                  <span set:html={`\\(${sf.latex}\\)`} />
                  <span class="text-tertiary text-xs ml-4">
                    {sf.description}
                  </span>
                </div>
              ))
            }
          </div>

          <div class="bg-accent-primary/5 border-l-2 border-accent-primary p-3">
            <p class="text-sm text-secondary mb-2">
              <strong class="text-primary">Why this formula works:</strong>
            </p>
            <ul class="text-sm text-secondary space-y-1 ml-4">
              {
                formulas.retentionValue.intuitionBulletsHtml?.map((bullet) => (
                  <li class="flex items-start gap-2">
                    <span class="text-accent-primary">+</span>
                    <span set:html={bullet} />
                  </li>
                ))
              }
            </ul>
          </div>
        </div>

        <!-- Total Value -->
        <div
          class="bg-accent-success-subtle border border-accent-success/20 p-4 rounded-lg"
        >
          <h3 class="text-lg font-semibold text-primary mb-3">
            {formulas.totalValue.title}
          </h3>
          <div
            class="text-base mb-2"
            set:html={`\\[${formulas.totalValue.formula}\\]`}
          />
          <p class="text-sm text-secondary">
            {formulas.totalValue.description}
          </p>
        </div>
      </div>

      <!-- Footer -->
      <div class="px-6 py-4 border-t border-border flex justify-end">
        <button id="closeModalFooterButton" class="btn btn-primary">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // TypeScript declaration for MathJax
  declare global {
    interface Window {
      MathJax?: {
        typesetPromise?: (elements: Element[]) => Promise<void>;
      };
    }
  }

  const modal = document.getElementById("formulaModal");
  const openButton = document.getElementById("formulaModalButton");
  const openButtonHero = document.getElementById("formulaModalButtonHero");
  const closeButton = document.getElementById("closeModalButton");
  const closeFooterButton = document.getElementById("closeModalFooterButton");
  const formulaContent = document.getElementById("formulaContent");

  function openModal() {
    if (modal) {
      modal.classList.remove("hidden");
      document.body.style.overflow = "hidden";

      // Trigger MathJax to render formulas in modal
      if (window.MathJax?.typesetPromise && formulaContent) {
        window.MathJax.typesetPromise([formulaContent]).catch(() => {
          // Silently handle errors
        });
      }
    }
  }

  function closeModal() {
    if (modal) {
      modal.classList.add("hidden");
      document.body.style.overflow = "";
    }
  }

  // All open buttons
  [openButton, openButtonHero].forEach((btn) => {
    if (btn) btn.addEventListener("click", openModal);
  });

  if (closeButton) {
    closeButton.addEventListener("click", closeModal);
  }

  if (closeFooterButton) {
    closeFooterButton.addEventListener("click", closeModal);
  }

  // Close on background click
  if (modal) {
    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });
  }

  // Close on Escape key
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modal && !modal.classList.contains("hidden")) {
      closeModal();
    }
  });
</script>
