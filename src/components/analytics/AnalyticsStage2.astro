---
/**
 * Analytics Stage 2: Conversion Flow
 *
 * Displays complaint-to-return conversion flow with:
 * - Flow nodes (complaints, resolved, returns)
 * - Animated arrows with percentages
 * - Count-up animations
 */

interface Props {
  complaints: number;
  resolved: number;
  returns: number;
  resolvedPercentage: number;
  returnPercentage: number;
  avgTimeToReturn: string;
  className?: string;
}

const {
  complaints,
  resolved,
  returns,
  resolvedPercentage,
  returnPercentage,
  avgTimeToReturn,
  className = "",
} = Astro.props;
---

<div class={`analytics-stage-2 ${className}`} data-stage="2">
  <div class="stage-header mb-8">
    <h3 class="text-lg sm:text-xl font-semibold text-primary mb-1">
      Pre-Return Intervention Flow
    </h3>
    <p class="text-sm text-secondary">Last 30 Days â€¢ 2,847 check-ins sent</p>
  </div>

  <div class="flow-diagram">
    <!-- Check-ins Node -->
    <div class="flow-node" data-node="complaints">
      <div
        class="node-circle bg-surface-elevated border-2 border-border w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-2"
      >
        <span class="text-2xl" aria-hidden="true">ðŸ’¬</span>
      </div>
      <div
        class="node-label text-sm font-medium text-secondary text-center mb-1"
      >
        Check-ins
      </div>
      <div
        class="node-count count-animated text-xl font-bold text-primary text-center"
        data-target={complaints}
      >
        0
      </div>
    </div>

    <!-- Arrow Grid Container -->
    <div class="arrows-container mt-6 mb-6">
      <!-- Horizontal Arrow to Resolved -->
      <div class="arrow-horizontal" data-from="complaints" data-to="resolved">
        <div class="arrow-line bg-accent-primary h-0.5 relative">
          <div
            class="arrow-head absolute right-0 top-1/2 -translate-y-1/2 w-0 h-0 border-l-8 border-l-accent-primary border-t-4 border-t-transparent border-b-4 border-b-transparent"
          >
          </div>
        </div>
        <span
          class="arrow-label text-xs font-semibold text-accent-primary mt-1 block text-center"
        >
          {resolvedPercentage}%
        </span>
      </div>

      <!-- Vertical Arrow to Returns -->
      <div class="arrow-vertical" data-from="complaints" data-to="returns">
        <div class="arrow-line bg-accent-primary w-0.5 h-16 relative mx-auto">
          <div
            class="arrow-head absolute bottom-0 left-1/2 -translate-x-1/2 w-0 h-0 border-t-8 border-t-accent-primary border-l-4 border-l-transparent border-r-4 border-r-transparent"
          >
          </div>
        </div>
        <span
          class="arrow-label text-xs font-semibold text-accent-primary mt-1 block text-center"
        >
          {returnPercentage}%
        </span>
      </div>
    </div>

    <!-- Bottom Row: Resolved and Returns -->
    <div class="bottom-nodes grid grid-cols-2 gap-8">
      <!-- Resolved Node -->
      <div class="flow-node" data-node="resolved">
        <div
          class="node-circle bg-accent-success/10 border-2 border-accent-success w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-2"
        >
          <span class="text-2xl text-accent-success" aria-hidden="true">âœ“</span>
        </div>
        <div
          class="node-label text-sm font-medium text-secondary text-center mb-1"
        >
          Resolved
        </div>
        <div
          class="node-count count-animated text-xl font-bold text-primary text-center"
          data-target={resolved}
        >
          0
        </div>
      </div>

      <!-- Returns Node -->
      <div class="flow-node" data-node="returns">
        <div
          class="node-circle bg-red-50 border-2 border-red-200 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-2"
        >
          <span class="text-2xl" aria-hidden="true">â†©</span>
        </div>
        <div
          class="node-label text-sm font-medium text-secondary text-center mb-1"
        >
          Still Returned
        </div>
        <div
          class="node-count count-animated text-xl font-bold text-primary text-center"
          data-target={returns}
        >
          0
        </div>
      </div>
    </div>
  </div>

  <div
    class="insight-pill mt-8 bg-accent-success/10 border border-accent-success/30 rounded-full px-4 py-2 text-center"
  >
    <span class="text-sm text-secondary"
      >Avg. Resolution Time: <span class="font-semibold text-accent-success"
        >{avgTimeToReturn}</span
      > â€¢ 78% resolved without return</span
    >
  </div>
</div>

<style>
  .analytics-stage-2 {
    opacity: 0;
    transform: translateY(10px);
    transition:
      opacity 400ms ease-out,
      transform 400ms ease-out;
  }

  .analytics-stage-2.stage-active {
    opacity: 1;
    transform: translateY(0);
  }

  .analytics-stage-2.stage-fading-out {
    opacity: 0;
    transition:
      opacity 800ms ease-out,
      transform 800ms ease-out;
  }

  .flow-node {
    opacity: 0;
    transform: scale(0.9);
    transition:
      opacity 300ms ease-out,
      transform 300ms ease-out;
  }

  .flow-node.is-visible {
    opacity: 1;
    transform: scale(1);
  }

  .arrow-horizontal,
  .arrow-vertical {
    opacity: 0;
    transition: opacity 300ms ease-out;
  }

  .arrow-horizontal.is-visible,
  .arrow-vertical.is-visible {
    opacity: 1;
  }

  .arrow-line {
    transform-origin: left center;
    transform: scaleX(0);
    transition: transform 600ms ease-out;
  }

  .arrow-vertical .arrow-line {
    transform-origin: top center;
    transform: scaleY(0);
  }

  .arrow-line.is-visible {
    transform: scaleX(1);
  }

  .arrow-vertical .arrow-line.is-visible {
    transform: scaleY(1);
  }

  .arrow-label {
    opacity: 0;
    transition: opacity 300ms ease-out 400ms;
  }

  .arrow-label.is-visible {
    opacity: 1;
  }

  .insight-pill {
    opacity: 0;
    transform: translateY(10px);
    transition:
      opacity 400ms ease-out,
      transform 400ms ease-out;
  }

  .insight-pill.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  @media (prefers-reduced-motion: reduce) {
    .analytics-stage-2,
    .flow-node,
    .arrow-horizontal,
    .arrow-vertical,
    .arrow-line,
    .arrow-label,
    .insight-pill {
      transition: none !important;
      opacity: 1 !important;
      transform: none !important;
    }
  }
</style>
