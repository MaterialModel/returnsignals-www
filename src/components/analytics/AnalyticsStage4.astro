---
/**
 * Analytics Stage 4: Metric Drill-Down
 *
 * Displays metric cards with drill-down capability:
 * - Grid of metric cards
 * - Expanded detail view
 * - Breakdown with mini bar charts
 */

interface Metric {
  id: string;
  label: string;
  value: string;
}

interface BreakdownItem {
  label: string;
  value: number;
  percentage: number;
}

interface Props {
  metrics: Metric[];
  expandedMetric: {
    id: string;
    label: string;
    value: string;
    breakdown: BreakdownItem[];
    trend: "up" | "down" | "flat";
  };
  className?: string;
}

const { metrics, expandedMetric, className = "" } = Astro.props;
---

<div class={`analytics-stage-4 ${className}`} data-stage="4">
  <div class="stage-header mb-6">
    <h3 class="text-lg sm:text-xl font-semibold text-primary mb-1">
      Impact Metrics
    </h3>
    <p class="text-sm text-secondary">
      Last 30 Days • Cost savings & efficiency
    </p>
  </div>

  <!-- Metrics Grid -->
  <div class="metrics-grid grid grid-cols-3 gap-3 mb-6">
    {
      metrics.map((metric) => (
        <div
          class={`metric-card bg-surface-base border-2 rounded-lg p-4 transition-all ${
            metric.id === expandedMetric.id
              ? "border-accent-primary"
              : "border-border"
          }`}
          data-metric={metric.id}
        >
          <div class="metric-label text-xs sm:text-sm text-secondary mb-1">
            {metric.label}
          </div>
          <div class="metric-value text-xl sm:text-2xl font-bold text-primary">
            {metric.value}
          </div>
        </div>
      ))
    }
  </div>

  <!-- Expanded Metric Detail -->
  <div
    class="expanded-metric bg-surface-subtle border border-border rounded-lg p-5"
  >
    <div class="expanded-header flex items-center justify-between mb-4">
      <h4 class="text-base font-semibold text-primary">
        {expandedMetric.label}: {expandedMetric.value}
      </h4>
      <span
        class={`trend-indicator text-xs font-medium px-2 py-1 rounded ${
          expandedMetric.trend === "up"
            ? "bg-accent-success/10 text-accent-success"
            : expandedMetric.trend === "down"
              ? "bg-red-500/10 text-red-600"
              : "bg-surface-elevated text-secondary"
        }`}
      >
        {
          expandedMetric.trend === "up"
            ? "↗ Trending Up"
            : expandedMetric.trend === "down"
              ? "↘ Trending Down"
              : "→ Stable"
        }
      </span>
    </div>

    <div class="breakdown-label text-sm font-medium text-secondary mb-3">
      By Category:
    </div>

    <div class="breakdown-list space-y-3">
      {
        expandedMetric.breakdown.map((item, index) => (
          <div class="breakdown-item opacity-0" data-item-index={index}>
            <div class="flex items-center justify-between mb-1.5">
              <span class="text-sm text-primary font-medium">{item.label}</span>
              <div class="flex items-center gap-2">
                <span class="text-sm font-semibold text-primary">
                  {item.value}
                </span>
                <span class="text-xs text-secondary">({item.percentage}%)</span>
              </div>
            </div>
            <div class="mini-bar-container h-1.5 bg-surface-elevated rounded-full overflow-hidden">
              <div
                class="mini-bar h-full bg-accent-primary rounded-full"
                data-width={`${item.percentage}%`}
                style="width: 0%; will-change: width;"
              />
            </div>
          </div>
        ))
      }
    </div>

    <!-- Mini Trend Chart Placeholder -->
    <div class="mini-chart mt-5 pt-4 border-t border-subtle">
      <div
        class="chart-placeholder h-24 bg-surface-base rounded border border-border flex items-center justify-center"
      >
        <div class="flex items-center gap-2">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 text-accent-primary"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"
            ></path>
          </svg>
          <span class="text-xs text-secondary">30-day trend</span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .analytics-stage-4 {
    opacity: 0;
    transform: translateY(10px);
    transition:
      opacity 400ms ease-out,
      transform 400ms ease-out;
  }

  .analytics-stage-4.stage-active {
    opacity: 1;
    transform: translateY(0);
  }

  .analytics-stage-4.stage-fading-out {
    opacity: 0;
    transition:
      opacity 800ms ease-out,
      transform 800ms ease-out;
  }

  .metric-card {
    opacity: 0;
    transform: scale(0.95);
    transition:
      opacity 300ms ease-out,
      transform 300ms ease-out,
      border-color 300ms ease-out;
  }

  .metric-card.is-visible {
    opacity: 1;
    transform: scale(1);
  }

  .metric-card.highlighted {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.1);
  }

  .expanded-metric {
    opacity: 0;
    max-height: 0;
    overflow: hidden;
    transition:
      opacity 400ms ease-out,
      max-height 600ms ease-out;
  }

  .expanded-metric.is-visible {
    opacity: 1;
    max-height: 600px;
  }

  .breakdown-item {
    transition:
      opacity 300ms ease-out,
      transform 300ms ease-out;
    transform: translateY(5px);
  }

  .breakdown-item.is-visible {
    opacity: 1 !important;
    transform: translateY(0);
  }

  .mini-chart {
    opacity: 0;
    transform: translateY(5px);
    transition:
      opacity 400ms ease-out,
      transform 400ms ease-out;
  }

  .mini-chart.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  @media (prefers-reduced-motion: reduce) {
    .analytics-stage-4,
    .metric-card,
    .expanded-metric,
    .breakdown-item,
    .mini-chart,
    .mini-bar {
      transition: none !important;
      opacity: 1 !important;
      transform: none !important;
      max-height: none !important;
    }
  }
</style>
