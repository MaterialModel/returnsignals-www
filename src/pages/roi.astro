---
import BaseLayout from "@layouts/BaseLayout.astro";
import Header from "@components/shared/Header.astro";
import Footer from "@components/shared/Footer.astro";
import FormulaModal from "@components/calculator/FormulaModal.astro";
import CalculatorInput from "@components/calculator/CalculatorInput.astro";
import InputSection from "@components/calculator/InputSection.astro";
import ResultsPanel from "@components/calculator/ResultsPanel.astro";
---

<BaseLayout
  title="ROI Calculator - Return Signals"
  description="Calculate the potential ROI of reducing returns and improving customer retention with Return Signals"
>
  <!-- MathJax for formula rendering -->
  <script is:inline>
    window.MathJax = {
      tex: {
        inlineMath: [
          ["$", "$"],
          ["\\(", "\\)"],
        ],
        displayMath: [
          ["$$", "$$"],
          ["\\[", "\\]"],
        ],
      },
      svg: {
        fontCache: "global",
      },
    };
  </script>
  <script
    is:inline
    id="MathJax-script"
    async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <Header />

  <main id="main-content">
    <!-- Hero Section -->
    <section class="py-12 sm:py-16">
      <div class="container-lg">
        <div class="text-center animate-on-scroll">
          <span class="eyebrow">Financial Impact</span>
          <h1 class="page-title mt-4 mb-6">ROI Calculator</h1>
          <p class="section-description max-w-3xl mx-auto">
            See how Return Signals can impact your bottom line by reducing
            returns, increasing exchanges, and improving customer retention.
          </p>
          <button
            id="formulaModalButtonHero"
            class="mt-6 inline-flex items-center gap-2 text-sm text-accent-primary hover:text-accent-hover transition-colors"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z"
              ></path>
            </svg>
            <span class="underline underline-offset-2"
              >Learn how we calculate ROI</span
            >
          </button>
        </div>
      </div>
    </section>

    <!-- Calculator Section -->
    <section class="pb-20 sm:pb-32">
      <div class="container-narrow">
        <div class="grid md:grid-cols-2 gap-8 lg:gap-12">
          <!-- Input Form -->
          <div class="space-y-8">
            <InputSection title="Business Metrics">
              <CalculatorInput
                id="unitsSold"
                label="Monthly Ecomm Units Sold (before returns)"
                value="30000"
                min="0"
              />
              <CalculatorInput
                id="avgRevenue"
                label="Average Unit Revenue ($)"
                value="200"
                min="0"
                step="0.01"
              />
              <CalculatorInput
                id="avgCost"
                label="Average Unit Cost ($)"
                value="70"
                min="0"
                step="0.01"
              />
              <CalculatorInput
                id="unitsPerOrder"
                label="Average Units Per Order"
                value="1.7"
                min="0.1"
                step="0.1"
              />
              <CalculatorInput
                id="orderShippingCost"
                label="Outbound Shipping Cost per Order ($)"
                value="10"
                min="0"
                step="0.01"
              />
              <CalculatorInput
                id="returnCost"
                label="Return Processing Cost per Unit ($)"
                value="10"
                min="0"
                step="0.01"
              />
            </InputSection>

            <InputSection title="Return Rates">
              <CalculatorInput
                id="fitReturnRate"
                label="Fit-Related Return Rate (%)"
                value="18"
                min="0"
                max="100"
                step="0.1"
              />
              <CalculatorInput
                id="otherReturnRate"
                label="Other Return Rate (%)"
                value="12"
                min="0"
                max="100"
                step="0.1"
              />
              <CalculatorInput
                id="multisizeFit"
                label="Multi-size Fit Orders (%)"
                value="25"
                min="0"
                max="100"
                step="0.1"
                helpText="Orders with multiple sizes where all but one are returned"
              />
              <CalculatorInput
                id="resaleProbability"
                label="Returned Unit Resale Probability (%)"
                value="85"
                min="0"
                max="100"
                step="0.1"
              />
            </InputSection>

            <InputSection title="Return Signals Impact">
              <CalculatorInput
                id="engagementRate"
                label="Customer Engagement Rate (%)"
                value="40"
                min="0"
                max="100"
                step="0.1"
                helpText="Percentage of customers with problems who engage with Return Signals"
              />
              <CalculatorInput
                id="exchangeLift"
                label="Return → Exchange Lift (%)"
                value="40"
                min="0"
                max="100"
                step="0.1"
              />
              <CalculatorInput
                id="keepLift"
                label="Return → Keep Item Lift (%)"
                value="10"
                min="0"
                max="100"
                step="0.1"
              />
              <CalculatorInput
                id="retentionLift"
                label="180-day Retention Lift (%)"
                value="20"
                min="0"
                max="100"
                step="0.1"
                helpText="Lift in repeat purchases for customers for whom we resolved their problem"
              />
            </InputSection>

            <InputSection title="Marketing Costs">
              <CalculatorInput
                id="repeatMarketingCost"
                label="Repeat Customer Marketing Cost ($)"
                value="0"
                min="0"
                step="0.01"
                helpText="Cost to acquire a repeat order from existing customers"
              />
            </InputSection>
          </div>

          <!-- Results Panel -->
          <ResultsPanel />
        </div>
      </div>
    </section>
  </main>

  <Footer />

  <!-- Formula Modal (at root level for proper z-index) -->
  <FormulaModal />
</BaseLayout>

<style>
  .card {
    @apply bg-surface-base border border-border rounded-lg p-6;
  }
</style>

<script>
  import "@utils/scroll-animations";
  import {
    calculateROI,
    formatCurrency,
    formatNumber,
    type CalculationInputs,
  } from "@components/calculator/calculations";

  // Get all input elements
  const inputs = {
    unitsSold: document.getElementById("unitsSold") as HTMLInputElement,
    avgRevenue: document.getElementById("avgRevenue") as HTMLInputElement,
    avgCost: document.getElementById("avgCost") as HTMLInputElement,
    unitsPerOrder: document.getElementById("unitsPerOrder") as HTMLInputElement,
    orderShippingCost: document.getElementById(
      "orderShippingCost",
    ) as HTMLInputElement,
    returnCost: document.getElementById("returnCost") as HTMLInputElement,
    fitReturnRate: document.getElementById("fitReturnRate") as HTMLInputElement,
    otherReturnRate: document.getElementById(
      "otherReturnRate",
    ) as HTMLInputElement,
    multisizeFit: document.getElementById("multisizeFit") as HTMLInputElement,
    resaleProbability: document.getElementById(
      "resaleProbability",
    ) as HTMLInputElement,
    engagementRate: document.getElementById(
      "engagementRate",
    ) as HTMLInputElement,
    exchangeLift: document.getElementById("exchangeLift") as HTMLInputElement,
    keepLift: document.getElementById("keepLift") as HTMLInputElement,
    retentionLift: document.getElementById("retentionLift") as HTMLInputElement,
    repeatMarketingCost: document.getElementById(
      "repeatMarketingCost",
    ) as HTMLInputElement,
  };

  // Get output elements
  const outputs = {
    displayValue: document.getElementById("displayValue"),
    exchangeValue: document.getElementById("exchangeValue"),
    keepValue: document.getElementById("keepValue"),
    retentionValue: document.getElementById("retentionValue"),
    eligibleReturns: document.getElementById("eligibleReturns"),
    engagedCustomers: document.getElementById("engagedCustomers"),
    resolvedCustomers: document.getElementById("resolvedCustomers"),
    returnsPrevented: document.getElementById("returnsPrevented"),
    baselineRevenue: document.getElementById("baselineRevenue"),
    marginExpansion: document.getElementById("marginExpansion"),
    profitLabel: document.getElementById("profitLabel"),
    baselineLabel: document.getElementById("baselineLabel"),
  };

  // Get toggle buttons
  const monthlyToggle = document.getElementById("monthlyToggle");
  const annualToggle = document.getElementById("annualToggle");

  // Toggle state
  let isAnnual = false;

  // Stored calculation values
  let calculationData = {
    monthly: 0,
    annual: 0,
    baselineMonthly: 0,
    baselineAnnual: 0,
  };

  function runCalculation() {
    // Gather inputs
    const inputValues: CalculationInputs = {
      unitsSold: parseFloat(inputs.unitsSold.value) || 0,
      avgRevenue: parseFloat(inputs.avgRevenue.value) || 0,
      avgCost: parseFloat(inputs.avgCost.value) || 0,
      unitsPerOrder: parseFloat(inputs.unitsPerOrder.value) || 1,
      orderShippingCost: parseFloat(inputs.orderShippingCost.value) || 0,
      returnCost: parseFloat(inputs.returnCost.value) || 0,
      fitReturnRate: parseFloat(inputs.fitReturnRate.value) || 0,
      otherReturnRate: parseFloat(inputs.otherReturnRate.value) || 0,
      multisizeFit: parseFloat(inputs.multisizeFit.value) || 0,
      resaleProbability: parseFloat(inputs.resaleProbability.value) || 0,
      engagementRate: parseFloat(inputs.engagementRate.value) || 0,
      exchangeLift: parseFloat(inputs.exchangeLift.value) || 0,
      keepLift: parseFloat(inputs.keepLift.value) || 0,
      retentionLift: parseFloat(inputs.retentionLift.value) || 0,
      repeatMarketingCost: parseFloat(inputs.repeatMarketingCost.value) || 0,
    };

    // Calculate results
    const results = calculateROI(inputValues);

    // Store for toggle
    calculationData = {
      monthly: results.totalMonthly,
      annual: results.totalAnnual,
      baselineMonthly: results.baselineMonthly,
      baselineAnnual: results.baselineAnnual,
    };

    // Update outputs
    if (outputs.exchangeValue)
      outputs.exchangeValue.textContent = formatCurrency(results.exchangeValue);
    if (outputs.keepValue)
      outputs.keepValue.textContent = formatCurrency(results.keepValue);
    if (outputs.retentionValue)
      outputs.retentionValue.textContent = formatCurrency(
        results.retentionValue,
      );
    if (outputs.eligibleReturns)
      outputs.eligibleReturns.textContent = formatNumber(
        results.eligibleReturns,
      );
    if (outputs.engagedCustomers)
      outputs.engagedCustomers.textContent = formatNumber(
        results.engagedCustomers,
      );
    if (outputs.resolvedCustomers)
      outputs.resolvedCustomers.textContent = formatNumber(
        results.resolvedCustomers,
      );
    if (outputs.returnsPrevented)
      outputs.returnsPrevented.textContent = formatNumber(
        results.returnsPrevented,
      );
    if (outputs.marginExpansion)
      outputs.marginExpansion.textContent =
        results.marginExpansionPct.toFixed(1) + "%";

    // Update display based on current toggle state
    updateDisplay();
  }

  function updateDisplay() {
    if (isAnnual) {
      if (outputs.profitLabel)
        outputs.profitLabel.textContent = "Annual Profit Increase";
      if (outputs.baselineLabel)
        outputs.baselineLabel.textContent = "Baseline Annual Net Sales";
      if (outputs.displayValue)
        outputs.displayValue.textContent = formatCurrency(
          calculationData.annual,
        );
      if (outputs.baselineRevenue)
        outputs.baselineRevenue.textContent = formatCurrency(
          calculationData.baselineAnnual,
        );
    } else {
      if (outputs.profitLabel)
        outputs.profitLabel.textContent = "Monthly Profit Increase";
      if (outputs.baselineLabel)
        outputs.baselineLabel.textContent = "Baseline Monthly Net Sales";
      if (outputs.displayValue)
        outputs.displayValue.textContent = formatCurrency(
          calculationData.monthly,
        );
      if (outputs.baselineRevenue)
        outputs.baselineRevenue.textContent = formatCurrency(
          calculationData.baselineMonthly,
        );
    }
  }

  function setToggleState(annual: boolean) {
    isAnnual = annual;

    if (monthlyToggle && annualToggle) {
      if (annual) {
        monthlyToggle.classList.remove("bg-accent-primary", "text-inverse");
        monthlyToggle.classList.add("text-secondary", "hover:text-primary");
        annualToggle.classList.add("bg-accent-primary", "text-inverse");
        annualToggle.classList.remove("text-secondary", "hover:text-primary");
      } else {
        annualToggle.classList.remove("bg-accent-primary", "text-inverse");
        annualToggle.classList.add("text-secondary", "hover:text-primary");
        monthlyToggle.classList.add("bg-accent-primary", "text-inverse");
        monthlyToggle.classList.remove("text-secondary", "hover:text-primary");
      }
    }

    updateDisplay();
  }

  // Add event listeners to all inputs
  Object.values(inputs).forEach((input) => {
    if (input) {
      input.addEventListener("input", runCalculation);
    }
  });

  // Add toggle event listeners
  if (monthlyToggle) {
    monthlyToggle.addEventListener("click", () => setToggleState(false));
  }
  if (annualToggle) {
    annualToggle.addEventListener("click", () => setToggleState(true));
  }

  // Calculate initial values
  runCalculation();
</script>
